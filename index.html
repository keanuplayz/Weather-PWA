<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather</title>
    <link rel="stylesheet" href="lib/css/style.css">

    <script type="module">
        import 'https://cdn.jsdelivr.net/npm/@pwabuilder/pwaupdate';

        const el = document.createElement('pwa-update');
        document.body.appendChild(el);
    </script>

    <script src="lib/modules/logger.js" type="module"></script>
    <script src="lib/modules/main.js" type="module"></script>

    <script>
        function doRequest() {
            const city = document.getElementById("cityField").value;
            const url =
                `https://api.weatherapi.com/v1/current.json?key=${window.localStorage.getItem('apiKey') || window.apiKey}&q=${city}`;

            fetch(url).then(function (response) {
                return response.json();
            }).then(function (data) {
                if (data.error) {
                    if (data.error.code == "1002") {
                        alert("The API key has not been provided. Create an issue on the GitHub repo.");
                        console.error("No API key provided.");
                    }
                    if (data.error.code == "1003") {
                        alert("You need to enter a location.");
                        console.error("The q parameter is missing. (No location provided.)");
                    }
                    if (data.error.code == "1005") {
                        alert("The API request URL is invalid. Create an issue on the GitHub repo.");
                        console.error("Invalid API request URL.");
                    }
                    if (data.error.code == "1006") {
                        alert("No matching location found.");
                        console.error("No matching location found.");
                    }
                    if (data.error.code == "2006") {
                        alert("Invalid API key. Create an issue on the GitHub repo.");
                        console.error("Invalid API key.");
                    }
                    if (data.error.code == "2007") {
                        alert("API key has exceeded monthly quota.");
                        console.error("API key quota exceeded.");
                    }
                    if (data.error.code == "2008") {
                        alert("API key has been disabled.");
                        console.error("API key disabled.");
                    }
                    if (data.error.code == "9999") {
                        alert("Internal application error.");
                        console.error("Internal application error.");
                    }
                } else {
                    console.log(data);
                    console.log(data.location.name);
                    let name = document.getElementById("name");
                    let region = document.getElementById("region");
                    let country = document.getElementById("country");
                    name.innerHTML = data.location.name;
                    region.innerHTML = data.location.region;
                    country.innerHTML = data.location.country;
                }
            }).catch((err) => {
                console.error(err, "error");
            })
        }

        function getWeather() {
            if (window.localStorage.getItem('apiKey') === null) {
                const keyPrompt = prompt("API Key");
                window.localStorage.setItem('apiKey', keyPrompt);
                doRequest();
            } else {
                doRequest();
            }
        }
    </script>
</head>

<body>
    <button id="buton">press</button>
    <textarea name="city" id="cityField" cols="30" rows="3"></textarea>
    <button id="weatherButton" onclick="getWeather()">get weather</button>
    <div id="genericInfo">
        <table>
            <tr>
                <th>Name</th>
                <th>Region</th>
                <th>Country</th>
            </tr>
            <tr>
                <td id="name">n/a</td>
                <td id="region">n/a</td>
                <td id="country">n/a</td>
            </tr>
        </table>
    </div>
</body>

</html>